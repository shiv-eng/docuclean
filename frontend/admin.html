<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - DocuClean Analytics</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 640px) {

            /* Reduce padding on mobile */
            .mobile-p-4 {
                padding: 1rem !important;
            }

            /* Mobile table cards */
            .mobile-card-view thead {
                display: none;
            }

            .mobile-card-view tbody tr {
                display: block;
                margin-bottom: 1rem;
                background: #f8fafc;
                border-radius: 0.75rem;
                padding: 1rem;
                border: 1px solid #e2e8f0;
            }

            .mobile-card-view tbody td {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem 0;
                border: none !important;
            }

            .mobile-card-view tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #475569;
                margin-right: 1rem;
            }

            /* Smaller text on mobile */
            .text-5xl {
                font-size: 2rem !important;
            }

            .text-4xl {
                font-size: 1.5rem !important;
            }

            .text-3xl {
                font-size: 1.25rem !important;
            }

            .text-2xl {
                font-size: 1.125rem !important;
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-8 mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-4xl font-bold text-slate-900">Admin Dashboard</h1>
                    <p class="text-sm sm:text-base text-slate-600 mt-1 sm:mt-2">DocuClean PDF Watermark Remover
                        Analytics</p>
                    <p class="text-xs sm:text-sm text-slate-500 mt-1" id="lastUpdated">Last updated: Loading...</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                    <button onclick="deleteDatabaseConfirm()"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 sm:px-6 py-2 sm:py-3 rounded-xl transition-colors flex items-center justify-center gap-2 text-sm sm:text-base">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span class="hidden xs:inline">Delete Database</span>
                        <span class="xs:hidden">Delete</span>
                    </button>
                    <button onclick="location.href='/'"
                        class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-4 sm:px-6 py-2 sm:py-3 rounded-xl transition-colors text-sm sm:text-base">
                        ‚Üê Back to App
                    </button>
                </div>
            </div>
        </div>

        <!-- Explanation Box -->
        <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-4 sm:p-6 mb-6 sm:mb-8">
            <div class="flex items-start space-x-3 sm:space-x-4">
                <div class="flex-shrink-0 hidden sm:block">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-base sm:text-lg font-bold text-blue-900 mb-2">üìä How User Tracking Works</h3>
                    <div class="space-y-2 text-xs sm:text-sm text-blue-800">
                        <p><strong>üìä Unique Users (New):</strong> Users who have visited the app exactly ONCE. They
                            opened the app for the first time and their visit count = 1.</p>
                        <p><strong>üîÑ Repeat Users:</strong> Users who have visited MORE than once. When they close the
                            browser and come back later, their visit count increases (2, 3, 4...). These are returning
                            users.</p>
                        <p><strong>üîí Persistent Tracking:</strong> We use localStorage to save a permanent user ID on
                            their device. This means even if they close the browser completely and reopen it days later,
                            we recognize them as the same user and increment their visit count.</p>
                        <p><strong>üìà Example:</strong> User opens app (visit_count=1, Unique User) ‚Üí Closes browser ‚Üí
                            Opens app again next day (visit_count=2, now Repeat User) ‚Üí Opens again (visit_count=3,
                            still Repeat User)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- üéØ PMF PROGRESS TRACKER -->
        <div
            class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-lg p-4 sm:p-8 mb-6 sm:mb-8 text-white">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
                <div>
                    <h2 class="text-lg sm:text-2xl font-bold">üéØ PMF Progress: Find 100 Users Who Love It</h2>
                    <p class="opacity-90 mt-1 text-xs sm:text-base">Track users with 3+ downloads - your potential
                        champions</p>
                </div>
                <div class="text-left sm:text-right">
                    <div class="text-4xl sm:text-5xl font-bold" id="pmfProgress">0</div>
                    <div class="text-xs sm:text-sm opacity-80">/ 100 Power Users</div>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="bg-white/20 rounded-full h-3 sm:h-4 overflow-hidden">
                <div id="pmfProgressBar" class="bg-white h-full rounded-full transition-all duration-500"
                    style="width: 0%"></div>
            </div>
            <div class="grid grid-cols-3 gap-2 sm:gap-6 mt-4 sm:mt-6">
                <div class="bg-white/10 rounded-xl p-2 sm:p-4 text-center">
                    <div class="text-xl sm:text-3xl font-bold" id="loveCount">0</div>
                    <div class="text-xs sm:text-sm opacity-80">üòç Love It!</div>
                </div>
                <div class="bg-white/10 rounded-xl p-2 sm:p-4 text-center">
                    <div class="text-xl sm:text-3xl font-bold" id="goodCount">0</div>
                    <div class="text-xs sm:text-sm opacity-80">üòä Good</div>
                </div>
                <div class="bg-white/10 rounded-xl p-2 sm:p-4 text-center">
                    <div class="text-xl sm:text-3xl font-bold" id="okayCount">0</div>
                    <div class="text-xs sm:text-sm opacity-80">üòê Okay</div>
                </div>
            </div>
        </div>

        <!-- Main Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <!-- Unique Users -->
            <div
                class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 text-white">
                <div class="flex items-center justify-between mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm font-medium opacity-90">Unique Users</h3>
                    <svg class="w-5 h-5 sm:w-8 sm:h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <div class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2" id="uniqueUsers">-</div>
                <p class="text-xs opacity-80 hidden sm:block">First-time visitors (visit_count = 1)</p>
                <p class="text-xs opacity-80 sm:hidden">New visitors</p>
            </div>

            <!-- Repeat Users -->
            <div
                class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 text-white">
                <div class="flex items-center justify-between mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm font-medium opacity-90">Repeat Users</h3>
                    <svg class="w-5 h-5 sm:w-8 sm:h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
                <div class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2" id="repeatUsers">-</div>
                <p class="text-xs opacity-80 hidden sm:block">Returning visitors (visit_count > 1)</p>
                <p class="text-xs opacity-80 sm:hidden">Returning</p>
            </div>

            <!-- Total Uploads -->
            <div
                class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 text-white">
                <div class="flex items-center justify-between mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm font-medium opacity-90">Total Uploads</h3>
                    <svg class="w-5 h-5 sm:w-8 sm:h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <div class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2" id="totalUploads">-</div>
                <p class="text-xs opacity-80 hidden sm:block">PDFs processed</p>
                <p class="text-xs opacity-80 sm:hidden">PDFs</p>
            </div>

            <!-- Total Downloads -->
            <div
                class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 text-white">
                <div class="flex items-center justify-between mb-2 sm:mb-4">
                    <h3 class="text-xs sm:text-sm font-medium opacity-90">Total Downloads</h3>
                    <svg class="w-5 h-5 sm:w-8 sm:h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </div>
                <div class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2" id="totalDownloads">-</div>
                <p class="text-xs opacity-80 hidden sm:block">Cleaned PDFs</p>
                <p class="text-xs opacity-80 sm:hidden">Downloads</p>
            </div>
        </div>

        <!-- Activity Metrics -->
        <div class="grid grid-cols-3 gap-2 sm:gap-6 mb-6 sm:mb-8">
            <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-200 p-3 sm:p-6">
                <h3 class="text-xs sm:text-sm font-semibold text-slate-600 mb-2 sm:mb-3">Page Visits</h3>
                <div class="text-2xl sm:text-5xl font-bold text-blue-600" id="pageVisits">-</div>
                <p class="text-xs text-slate-500 mt-1 sm:mt-2 hidden sm:block">Total page loads</p>
            </div>

            <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-200 p-3 sm:p-6">
                <h3 class="text-xs sm:text-sm font-semibold text-slate-600 mb-2 sm:mb-3">Completion</h3>
                <div class="text-2xl sm:text-5xl font-bold text-green-600" id="completionRate">-%</div>
                <p class="text-xs text-slate-500 mt-1 sm:mt-2 hidden sm:block">Downloads / Uploads</p>
            </div>

            <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-200 p-3 sm:p-6">
                <h3 class="text-xs sm:text-sm font-semibold text-slate-600 mb-2 sm:mb-3">Engagement</h3>
                <div class="text-2xl sm:text-5xl font-bold text-purple-600" id="engagementRate">-%</div>
                <p class="text-xs text-slate-500 mt-1 sm:mt-2 hidden sm:block">Uploads / Visits</p>
            </div>
        </div>

        <!-- üíú POWER USERS (Champions) -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border-2 border-purple-200 p-4 sm:p-8 mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6">
                <div>
                    <h2 class="text-lg sm:text-2xl font-bold text-purple-900">üíú Power Users (Champions)</h2>
                    <p class="text-xs sm:text-sm text-slate-500 mt-1">Users with 3+ downloads - they love your product!
                    </p>
                </div>
                <div
                    class="bg-purple-100 text-purple-800 px-3 sm:px-4 py-1 sm:py-2 rounded-full font-bold text-sm sm:text-lg">
                    <span id="powerUserCount">0</span> champions
                </div>
            </div>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <table class="w-full min-w-[400px]">
                    <thead class="bg-purple-50 border-b-2 border-purple-200">
                        <tr>
                            <th
                                class="text-left py-2 sm:py-3 px-3 sm:px-4 text-xs sm:text-sm font-bold text-purple-800">
                                User ID</th>
                            <th
                                class="text-left py-2 sm:py-3 px-3 sm:px-4 text-xs sm:text-sm font-bold text-purple-800">
                                Downloads</th>
                            <th
                                class="text-left py-2 sm:py-3 px-3 sm:px-4 text-xs sm:text-sm font-bold text-purple-800">
                                Uploads</th>
                            <th
                                class="text-left py-2 sm:py-3 px-3 sm:px-4 text-xs sm:text-sm font-bold text-purple-800">
                                Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="powerUsersTable">
                        <tr>
                            <td colspan="4" class="text-center py-6 sm:py-8 text-slate-500 text-sm">Loading power
                                users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Activity Details -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6">
                <div>
                    <h2 class="text-lg sm:text-2xl font-bold text-slate-900">User Activity Details</h2>
                    <p class="text-xs sm:text-sm text-slate-500 mt-1">Complete breakdown of each user's actions</p>
                </div>
                <button onclick="exportData()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 sm:px-6 py-2 sm:py-3 rounded-xl transition-colors flex items-center space-x-2 text-sm sm:text-base w-full sm:w-auto justify-center">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Export CSV</span>
                </button>
            </div>

            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <table class="w-full min-w-[600px]">
                    <thead class="bg-slate-50 border-b-2 border-slate-200">
                        <tr>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                Session ID</th>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                Type</th>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                Visits</th>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                Uploads</th>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                Downloads</th>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                First Seen</th>
                            <th class="text-left py-3 sm:py-4 px-3 sm:px-4 text-xs sm:text-sm font-bold text-slate-700">
                                Last Seen</th>
                        </tr>
                    </thead>
                    <tbody id="userActivityTable">
                        <tr>
                            <td colspan="7" class="text-center py-8 sm:py-12 text-slate-500 text-sm">Loading user
                                data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
            <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-center text-gray-900 mb-2">Delete All Analytics?</h3>
            <p class="text-center text-gray-600 mb-6">This will permanently delete all analytics data including user
                tracking, uploads, and downloads. This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
                    Cancel
                </button>
                <button onclick="deleteDatabase()"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    Delete Everything
                </button>
            </div>
        </div>
    </div>

    <script>
        // Format date and time
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Delete database functions
        function deleteDatabaseConfirm() {
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function deleteDatabase() {
            try {
                const response = await fetch('/analytics/delete-database', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Success! Deleted ${result.records_deleted} records`);
                    closeDeleteModal();
                    // Reload stats
                    loadStats();
                    loadUserActivity();
                    loadPMFStats();
                } else {
                    alert('‚ùå Failed to delete database: ' + result.detail);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå Failed to delete database');
            }
        }

        // Load comprehensive stats
        async function loadStats() {
            try {
                const response = await fetch('/analytics/admin-stats');
                const stats = await response.json();

                document.getElementById('uniqueUsers').textContent = stats.unique_users.toLocaleString();
                document.getElementById('repeatUsers').textContent = stats.repeat_users.toLocaleString();
                document.getElementById('totalUploads').textContent = stats.total_uploads.toLocaleString();
                document.getElementById('totalDownloads').textContent = stats.total_downloads.toLocaleString();
                document.getElementById('pageVisits').textContent = stats.page_visits.toLocaleString();

                // Calculate rates
                const completionRate = stats.total_uploads > 0
                    ? Math.round((stats.total_downloads / stats.total_uploads) * 100)
                    : 0;
                const engagementRate = stats.page_visits > 0
                    ? Math.round((stats.total_uploads / stats.page_visits) * 100)
                    : 0;

                document.getElementById('completionRate').textContent = completionRate + '%';
                document.getElementById('engagementRate').textContent = engagementRate + '%';

                document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load user activity details
        async function loadUserActivity() {
            try {
                const response = await fetch('/analytics/user-details');
                const result = await response.json();

                const tbody = document.getElementById('userActivityTable');

                if (result.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-slate-500">No user data yet</td></tr>';
                    return;
                }

                tbody.innerHTML = result.users.map(user => `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="py-4 px-4">
                            <span class="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded">${user.session_id.substring(0, 20)}...</span>
                        </td>
                        <td class="py-4 px-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${user.is_repeat ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                ${user.is_repeat ? 'Repeat' : 'Unique'}
                            </span>
                        </td>
                        <td class="py-4 px-4">
                            <span class="text-sm font-semibold text-slate-900">${user.visit_count}</span>
                            <span class="text-xs text-slate-500">visits</span>
                        </td>
                        <td class="py-4 px-4">
                            <span class="text-sm font-semibold text-purple-600">${user.upload_count}</span>
                            <span class="text-xs text-slate-500">files</span>
                        </td>
                        <td class="py-4 px-4">
                            <span class="text-sm font-semibold text-green-600">${user.download_count}</span>
                            <span class="text-xs text-slate-500">files</span>
                        </td>
                        <td class="py-4 px-4 text-sm text-slate-600">
                            <div>${formatDate(user.first_seen)}</div>
                            <div class="text-xs text-slate-400">${formatTime(user.first_seen)}</div>
                        </td>
                        <td class="py-4 px-4 text-sm text-slate-600">
                            <div>${formatDate(user.last_seen)}</div>
                            <div class="text-xs text-slate-400">${formatTime(user.last_seen)}</div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load user activity:', error);
            }
        }

        // Export data
        async function exportData() {
            try {
                const response = await fetch('/analytics/export-csv');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `docuclean_analytics_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export data');
            }
        }

        // Close modal on outside click
        document.getElementById('deleteModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        // Load PMF Progress Stats
        async function loadPMFStats() {
            try {
                const response = await fetch('/analytics/pmf-stats');
                if (response.ok) {
                    const stats = await response.json();

                    // Update PMF progress
                    const pmfCount = stats.power_users || 0;
                    document.getElementById('pmfProgress').textContent = pmfCount;
                    document.getElementById('powerUserCount').textContent = pmfCount;

                    // Update progress bar (0-100%)
                    const progressPercent = Math.min((pmfCount / 100) * 100, 100);
                    document.getElementById('pmfProgressBar').style.width = progressPercent + '%';

                    // Update reaction counts - ALL THREE NOW
                    document.getElementById('loveCount').textContent = (stats.love_reactions || 0).toLocaleString();
                    document.getElementById('goodCount').textContent = (stats.good_reactions || 0).toLocaleString();
                    document.getElementById('okayCount').textContent = (stats.okay_reactions || 0).toLocaleString();

                    console.log('‚úÖ PMF Stats loaded:', stats);
                } else {
                    console.error('PMF stats endpoint failed');
                }
            } catch (error) {
                console.error('Failed to load PMF stats:', error);
            }

            // Load power users table
            await loadPowerUsersTable();
        }

        // Load Power Users Table
        async function loadPowerUsersTable() {
            try {
                const response = await fetch('/analytics/user-details');
                const result = await response.json();

                // Filter power users (3+ downloads)
                const powerUsers = result.users.filter(u => u.download_count >= 3);

                const tbody = document.getElementById('powerUsersTable');
                if (powerUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-500">No power users yet. Get users to download 3+ times!</td></tr>';
                } else {
                    tbody.innerHTML = powerUsers.map(user => `
                        <tr class="border-b border-purple-100 hover:bg-purple-50 transition-colors">
                            <td class="py-3 px-4">
                                <span class="text-xs font-mono text-purple-600 bg-purple-100 px-2 py-1 rounded">${user.session_id.substring(0, 16)}...</span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="text-lg font-bold text-purple-600">${user.download_count}</span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="text-lg font-bold text-indigo-600">${user.upload_count}</span>
                            </td>
                            <td class="py-3 px-4 text-sm text-slate-600">
                                ${formatDate(user.last_seen)}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load power users table:', error);
                document.getElementById('powerUsersTable').innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-500">Error loading power users</td></tr>';
            }
        }

        // Initialize
        loadStats();
        loadUserActivity();
        loadPMFStats();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStats();
            loadUserActivity();
            loadPMFStats();
        }, 30000);
    </script>
</body>

</html>